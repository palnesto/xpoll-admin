
src/components/commons/form/utils/rhfSubmit.ts
----------------------------------------------
// src/components/form/utils/rhfSubmit.ts
import type {
  FieldValues,
  SubmitHandler,
  UseFormReturn,
} from "react-hook-form";
import { z } from "zod";
import { normalizeFormDataBySchema } from "./normalizeFormData";

export function handleSubmitNormalized<T extends FieldValues>(
  schema: z.ZodObject<any>,
  form: UseFormReturn<T>,
  onValid: SubmitHandler<T>,
) {
  return form.handleSubmit((data) => {
    const normalized = normalizeFormDataBySchema(schema, data);
    return onValid(normalized);
  });
}


src/components/commons/form/utils/normalizeFormData.ts
------------------------------------------------------
// src/components/form/utils/normalizeFormData.ts
import { z } from "zod";
import { getZodFieldMeta } from "./zodFieldMeta";

export function normalizeFormDataBySchema<T extends Record<string, any>>(
  schema: z.ZodObject<any>,
  data: T,
): T {
  const out: any = { ...data };
  const shape = schema.shape as Record<string, z.ZodTypeAny>;

  for (const key of Object.keys(shape)) {
    const meta = getZodFieldMeta(schema, key);

    // If optional field is undefined, turn into null
    if (meta.optional && out[key] === undefined) {
      if (meta.base === "string" || meta.base === "number") {
        out[key] = null;
      }
    }
  }

  return out as T;
}


src/components/commons/form/utils/zodFieldMeta.ts
-------------------------------------------------
// src/components/form/utils/zodFieldMeta.ts
import { z } from "zod";

type AnyZod = z.ZodTypeAny;

function unwrapAll(t: AnyZod): AnyZod {
  let cur: AnyZod = t;
  while (cur instanceof z.ZodEffects) cur = cur._def.schema;
  if (cur instanceof z.ZodDefault) cur = cur._def.innerType;
  return cur;
}

function peelOptionalNullable(t: AnyZod) {
  let cur: AnyZod = unwrapAll(t);
  let optional = false;
  let nullable = false;

  while (cur instanceof z.ZodOptional || cur instanceof z.ZodNullable) {
    if (cur instanceof z.ZodOptional) optional = true;
    if (cur instanceof z.ZodNullable) nullable = true;
    cur = unwrapAll(cur._def.innerType);
  }

  return { inner: cur, optional, nullable };
}

function getFieldSchema(schema: z.ZodObject<any>, path: string): AnyZod {
  const parts = path.split(".");
  let cur: AnyZod = schema;

  for (const p of parts) {
    const u = unwrapAll(cur);
    if (!(u instanceof z.ZodObject)) {
      throw new Error(`Path "${path}" is not a ZodObject at "${p}"`);
    }
    const shape = u.shape as Record<string, AnyZod>;
    cur = shape[p];
    if (!cur) throw new Error(`Field "${p}" not found in schema for "${path}"`);
  }

  return cur;
}

export function getZodFieldMeta(schema: z.ZodObject<any>, path: string) {
  const field = getFieldSchema(schema, path);
  const { inner, optional, nullable } = peelOptionalNullable(field);

  const base =
    inner instanceof z.ZodString
      ? "string"
      : inner instanceof z.ZodNumber
        ? "number"
        : "other";

  return { optional, nullable, base };
}

export function getZodStringMax(
  schema: z.ZodObject<any>,
  path: string,
): number | null {
  const field = getFieldSchema(schema, path);
  const { inner } = peelOptionalNullable(field);
  if (!(inner instanceof z.ZodString)) return null;

  const checks = (inner._def as any)?.checks as Array<any> | undefined;
  const maxCheck = checks?.find((c) => c.kind === "max");
  return typeof maxCheck?.value === "number" ? maxCheck.value : null;
}


src/components/commons/form/NumberField.tsx
-------------------------------------------
// src/components/commons/form/NumberField.tsx
import { useEffect, useState } from "react";
import type { FieldValues, Path, UseFormReturn } from "react-hook-form";
import { Controller, useWatch } from "react-hook-form";
import { z } from "zod";
import { cn } from "@/lib/utils";
import { getZodFieldMeta } from "./utils/zodFieldMeta";

type Props<T extends FieldValues> = {
  form: UseFormReturn<T>;
  schema: z.ZodObject<any>;
  name: Path<T>;
  label?: string;
  placeholder?: string;
  helperText?: string;
  decimalScale?: number;
  showError?: boolean;
  className?: string;
};

function isValidNumericInput(raw: string, decimalScale: number) {
  if (!/^-?\d*\.?\d*$/.test(raw)) return false;

  if (decimalScale <= 0) return /^-?\d*$/.test(raw);

  const parts = raw.split(".");
  if (parts.length > 2) return false;
  if (parts[1] && parts[1].length > decimalScale) return false;

  return true;
}

export function NumberField<T extends FieldValues>({
  form,
  schema,
  name,
  label,
  placeholder,
  helperText,
  decimalScale = 0,
  showError,
  className,
}: Props<T>) {
  const { control, setValue, getValues, formState } = form;
  const meta = getZodFieldMeta(schema, String(name));
  const err = (formState.errors as any)?.[name]?.message as string | undefined;
  const isRequired = !!label && !meta.optional;

  const [text, setText] = useState<string>("");
  const watchedValue = useWatch({ control, name });

  useEffect(() => {
    if (meta.base !== "number") return;
    const v = getValues(name);
    if (!meta.optional && v === undefined) {
      setValue(name, 0 as any, { shouldDirty: false, shouldTouch: false });
    }
  }, [meta.base, meta.optional, getValues, name, setValue]);

  useEffect(() => {
    const v = watchedValue as any;

    if (v === undefined || v === null) {
      if (text === "" || text === "-" || text === "." || text === "-.")
        setText("");
      return;
    }

    const next = String(v);
    if (next !== text) setText(next);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [watchedValue]);

  return (
    <div className={cn("space-y-2", className)}>
      {label ? (
        <label className="text-sm font-normal tracking-wide">
          {label}
          {isRequired ? <span className="ml-1 text-red-600">*</span> : null}
        </label>
      ) : null}

      <Controller
        control={control}
        name={name}
        render={({ field }) => (
          <>
            <input
              inputMode={decimalScale > 0 ? "decimal" : "numeric"}
              value={text}
              placeholder={placeholder}
              onBlur={(e) => {
                field.onBlur();
                const raw = e.target.value.trim();

                if (raw === "" || raw === "-" || raw === "." || raw === "-.") {
                  if (meta.optional) {
                    field.onChange(undefined);
                    setText("");
                  } else {
                    field.onChange(0);
                    setText("0");
                  }
                  return;
                }

                const n = Number(raw);
                if (!Number.isFinite(n)) {
                  if (meta.optional) {
                    field.onChange(undefined);
                    setText("");
                  } else {
                    field.onChange(0);
                    setText("0");
                  }
                  return;
                }

                field.onChange(n);
                setText(String(n));
              }}
              onChange={(e) => {
                const raw = e.target.value;

                if (raw === "") {
                  setText("");
                  if (meta.optional) field.onChange(undefined);
                  else field.onChange(0);
                  return;
                }

                if (!isValidNumericInput(raw, decimalScale)) return;

                setText(raw);

                if (
                  raw === "-" ||
                  raw === "." ||
                  raw === "-." ||
                  raw.endsWith(".")
                )
                  return;

                const n = Number(raw);
                if (Number.isFinite(n)) field.onChange(n);
              }}
              className={cn(
                "w-full h-11 rounded-2xl border px-3 text-base font-light tracking-wide bg-transparent outline-none focus:ring-2",
                err
                  ? "border-red-500 focus:ring-red-200"
                  : "border-border focus:ring-muted",
              )}
            />

            {helperText ? (
              <div className="mt-1 text-xs text-muted-foreground">
                {helperText}
              </div>
            ) : null}

            {showError && err ? (
              <div className="text-xs text-destructive">{err}</div>
            ) : null}
          </>
        )}
      />
    </div>
  );
}


src/components/commons/form/TextField.tsx
-----------------------------------------
// src/components/commons/form/TextField.tsx
import { useEffect } from "react";
import type { FieldValues, Path, UseFormReturn } from "react-hook-form";
import { Controller } from "react-hook-form";
import { z } from "zod";
import { cn } from "@/lib/utils";
import { getZodFieldMeta, getZodStringMax } from "./utils/zodFieldMeta";

type Props<T extends FieldValues> = {
  form: UseFormReturn<T>;
  schema: z.ZodObject<any>;
  name: Path<T>;
  label?: string;
  placeholder?: string;
  helperText?: string;
  showError?: boolean;
  showCounter?: boolean;
  className?: string;
};

export function TextField<T extends FieldValues>({
  form,
  schema,
  name,
  label,
  placeholder,
  helperText,
  showError,
  showCounter,
  className,
}: Props<T>) {
  const { control, setValue, getValues, formState } = form;

  const meta = getZodFieldMeta(schema, String(name));
  const maxLen = getZodStringMax(schema, String(name));
  const isRequired = !!label && !meta.optional;

  useEffect(() => {
    if (meta.base !== "string") return;
    const v = getValues(name);
    if (!meta.optional && v === undefined) {
      setValue(name, "" as any, { shouldDirty: false, shouldTouch: false });
    }
  }, [meta.base, meta.optional, getValues, name, setValue]);

  const err = (formState.errors as any)?.[name]?.message as string | undefined;

  return (
    <div className={cn("space-y-2", className)}>
      {label ? (
        <label className="text-sm font-normal tracking-wide">
          {label}
          {isRequired ? <span className="ml-1 text-red-600">*</span> : null}
        </label>
      ) : null}

      <Controller
        control={control}
        name={name}
        render={({ field }) => {
          const value = field.value ?? "";
          const len = String(value).length;

          return (
            <>
              <input
                value={value}
                placeholder={placeholder}
                onBlur={field.onBlur}
                onChange={(e) => {
                  const raw = e.target.value;

                  // optional string: empty => undefined (later normalized to null on submit)
                  if (
                    meta.base === "string" &&
                    meta.optional &&
                    raw.trim() === ""
                  ) {
                    field.onChange(undefined);
                    return;
                  }

                  field.onChange(raw);
                }}
                className={cn(
                  "w-full h-11 rounded-2xl border px-3 text-base font-light tracking-wide bg-transparent outline-none focus:ring-2",
                  err
                    ? "border-red-500 focus:ring-red-200"
                    : "border-border focus:ring-muted",
                )}
              />

              {showCounter || helperText ? (
                <div className="mt-1 flex items-start justify-between gap-3">
                  {helperText ? (
                    <div className="text-xs text-muted-foreground">
                      {helperText}
                    </div>
                  ) : (
                    <div />
                  )}

                  {showCounter ? (
                    <div className="text-xs text-muted-foreground">
                      {maxLen ? `${len}/${maxLen}` : len}
                    </div>
                  ) : null}
                </div>
              ) : null}

              {showError && err ? (
                <div className="text-xs text-destructive">{err}</div>
              ) : null}
            </>
          );
        }}
      />
    </div>
  );
}


src/components/commons/form/examples/ExampleForm.tsx
----------------------------------------------------
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { cn } from "@/lib/utils";
import { z } from "zod";
import { TextField } from "../TextField";
import { NumberField } from "../NumberField";
import { handleSubmitNormalized } from "../utils/rhfSubmit";
import { TextAreaField } from "../TextAreaField";

export const exampleFormZ = z.object({
  title: z.string().min(1, "Title is required").max(300),
  description: z.string().max(150).optional(),
  rewardAmountCap: z.number().min(1, "Total tokens must be > 0"),
  price: z.number().min(1, "Price must be ≥ 0"),
  discount: z.number().optional(),
});

export type ExampleFormValues = z.infer<typeof exampleFormZ>;
export default function ExampleForm() {
  const form = useForm<ExampleFormValues>({
    mode: "onChange",
    resolver: zodResolver(exampleFormZ),
  });
  const {
    formState: { isValid, isSubmitting },
  } = form;
  const onSubmit = (data: ExampleFormValues) => {
    console.log("FORM DATA →", data);
  };
  return (
    <div className="max-w-xl mx-auto mt-16 rounded-2xl border bg-white p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-gray-900">Create something</h2>
      <form
        onSubmit={handleSubmitNormalized(exampleFormZ, form, onSubmit)}
        className="mt-6 space-y-5"
        noValidate
      >
        <TextField<ExampleFormValues>
          form={form}
          schema={exampleFormZ}
          name="title"
          label="Title"
          placeholder="Enter title"
          helperText="A short title users will see in the list. A short title users will see in the list. A short title users will see in the list. A short title users will see in the list. A short title users will see in the list. A short title users will see in the list."
          showCounter
          showError
        />
        <NumberField<ExampleFormValues>
          form={form}
          schema={exampleFormZ}
          name="rewardAmountCap"
          label="Reward Amount Cap"
          placeholder="0"
          decimalScale={0}
          helperText="Total tokens allowed for this campaign."
          showError
        />
        <NumberField<ExampleFormValues>
          form={form}
          schema={exampleFormZ}
          name="price"
          label="Price"
          placeholder="0.00"
          decimalScale={2}
          helperText="2 decimal places allowed."
          showError
        />
        <NumberField<ExampleFormValues>
          form={form}
          schema={exampleFormZ}
          name="discount"
          label="Discount (optional)"
          placeholder="0.00"
          decimalScale={3}
          helperText="Leave empty if no discount."
          showError
        />
        <TextAreaField<ExampleFormValues>
          form={form}
          schema={exampleFormZ}
          name="description"
          label="Description"
          placeholder="Explain in a short sentence…"
          helperText="Optional. Max 150 characters."
          rows={4}
          showCounter
          showError
        />
        <button
          type="submit"
          disabled={!isValid || isSubmitting}
          className={cn(
            "w-full rounded-full py-3 text-sm font-semibold text-white transition",
            isValid
              ? "bg-blue hover:bg-[#29d8d8]"
              : "bg-gray-300 cursor-not-allowed",
          )}
        >
          Submit
        </button>
      </form>
    </div>
  );
}


src/components/commons/form/TextAreaField.tsx
---------------------------------------------
// src/components/commons/form/TextAreaField.tsx
import { useEffect } from "react";
import type { FieldValues, Path, UseFormReturn } from "react-hook-form";
import { Controller } from "react-hook-form";
import { z } from "zod";
import { cn } from "@/lib/utils";
import { getZodFieldMeta, getZodStringMax } from "./utils/zodFieldMeta";

type Props<T extends FieldValues> = {
  form: UseFormReturn<T>;
  schema: z.ZodObject<any>;
  name: Path<T>;
  label?: string;
  placeholder?: string;
  helperText?: string;
  rows?: number;
  showError?: boolean;
  showCounter?: boolean;
  className?: string;
};

export function TextAreaField<T extends FieldValues>({
  form,
  schema,
  name,
  label,
  placeholder,
  helperText,
  rows = 4,
  showError,
  showCounter,
  className,
}: Props<T>) {
  const { control, setValue, getValues, formState } = form;

  const meta = getZodFieldMeta(schema, String(name));
  const maxLen = getZodStringMax(schema, String(name));
  const isRequired = !!label && !meta.optional;

  useEffect(() => {
    if (meta.base !== "string") return;
    const v = getValues(name);
    if (!meta.optional && v === undefined) {
      setValue(name, "" as any, { shouldDirty: false, shouldTouch: false });
    }
  }, [meta.base, meta.optional, getValues, name, setValue]);

  const err = (formState.errors as any)?.[name]?.message as string | undefined;

  return (
    <div className={cn("space-y-2", className)}>
      {label ? (
        <label className="text-sm font-normal tracking-wide">
          {label}
          {isRequired ? <span className="ml-1 text-red-600">*</span> : null}
        </label>
      ) : null}

      <Controller
        control={control}
        name={name}
        render={({ field }) => {
          const value = field.value ?? "";
          const len = String(value).length;

          return (
            <>
              <textarea
                value={value}
                rows={rows}
                placeholder={placeholder}
                onBlur={field.onBlur}
                onChange={(e) => {
                  const raw = e.target.value;

                  if (
                    meta.base === "string" &&
                    meta.optional &&
                    raw.trim() === ""
                  ) {
                    field.onChange(undefined);
                    return;
                  }

                  field.onChange(raw);
                }}
                className={cn(
                  "w-full min-h-[120px] rounded-2xl border px-3 py-2 text-base font-light tracking-wide bg-transparent outline-none focus:ring-2",
                  err
                    ? "border-red-500 focus:ring-red-200"
                    : "border-border focus:ring-muted",
                )}
              />

              {showCounter || helperText ? (
                <div className="mt-1 flex items-start justify-between gap-3">
                  {helperText ? (
                    <div className="text-xs text-muted-foreground">
                      {helperText}
                    </div>
                  ) : (
                    <div />
                  )}

                  {showCounter ? (
                    <div className="text-xs text-muted-foreground">
                      {maxLen ? `${len}/${maxLen}` : len}
                    </div>
                  ) : null}
                </div>
              ) : null}

              {showError && err ? (
                <div className="text-xs text-destructive">{err}</div>
              ) : null}
            </>
          );
        }}
      />
    </div>
  );
}
